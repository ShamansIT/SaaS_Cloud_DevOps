name: CI/CD Bootstrap

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: bootstrap-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  bootstrap:
    name: Safe bootstrap pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check (no-op)
        run: |
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref : $GITHUB_REF"
          echo "CI environment ready (no dependencies required)"

      # CloudFormation lint 
      - name: Lint CloudFormation (conditional)
        if: ${{ hashFiles('aws-cloudformation/**/*.y*ml') != '' }}
        run: |
          python3 -V
          python3 -m pip install --upgrade pip
          pip3 install cfn-lint
          cfn-lint aws-cloudformation/**/*.y*ml

      # Terraform validate
      - name: Setup Terraform (conditional)
        if: ${{ hashFiles('terraform/**/*.tf') != '' }}
        uses: hashicorp/setup-terraform@v3

      - name: Terraform validate (conditional)
        if: ${{ hashFiles('terraform/**/*.tf') != '' }}
        run: |
          terraform -v
          terraform -chdir=terraform init -backend=false
          terraform -chdir=terraform validate

      # Deploy placeholder
      - name: Staging placeholder
        if: github.ref == 'refs/heads/dev'
        run: echo "Staging placeholder TODO:(add deploy-to-dev)"

      - name: Production placeholder
        if: github.ref == 'refs/heads/main'
        run: echo "Production placeholder TODO:(add deploy-to-prod)"
